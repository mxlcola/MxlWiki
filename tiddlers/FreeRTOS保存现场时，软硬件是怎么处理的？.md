## PSP和MSP的区别

- **Cortex-M 任务在“线程态(Thread mode)”运行，使用 [[PSP]]（Process Stack Pointer，[[进程栈]]）。**
- **异常处理（比如 SysTick、PendSV、SVC）在“处理态(Handler mode)”运行，使用 [[MSP]]（Main Stack Pointer，主栈）。**


## Q:硬件软件分别处理了哪些寄存器？

当触发一次[[上下文切换]]时（通常 SysTick 里把 **PendSV** 置位），**硬件先入栈一批通用寄存器**（称“硬件自动保存帧”），**入到当前活动的 SP 上（也就是任务的 PSP）**，然后再切换到 MSP 来执行异常处理程序的代码（也就是你看到的 `xPortPendSVHandler`）。
 
之后，**软件（这段汇编）**会把那批**硬件没管的寄存器**（r4–r11）也压到任务的 PSP 上，并把“任务栈顶”写回 TCB。再选下一个任务，从它的 TCB 读出 PSP，**弹出 r4–r11**，最后用 `bx r14` 退出异常时，**硬件**会自动从 PSP 把**那批“硬件帧”（r0–r3、r12、lr、pc、xPSR）**也弹出来，于是就“回到”下一任务继续跑了。

>一句话：**硬件负责“半包”（r0–r3、r12、lr、pc、xPSR），软件补全另一半（r4–r11），两人搭档把现场完整存/取。**

------

{{现场寄存器软硬件处理}}