> **寄存器组介绍**
> 
> 处理器拥有 R0-R15 的寄存器组，其中 R13 为堆栈指针 SP,SP 有两个，但是同一时刻只能有一个可以看到，这就是所谓的 “banked”(影子) 寄存器。  
> a、R0-R12 都是 32 位通用寄存器，用于数据操作。但是注意：绝大多数 16 位 Thumb 指令只能访问 R0-R7，而 32 位 Thumb-2 指令可以访问所有寄存器，函数调用时的形参和局部变量被压入在其中。         
> 
> b、Cortex-M3 拥有两个堆栈指针，然而它们是 banked，因此任一时刻只能使用其中的一个。   
>   **[[主堆栈指针（MSP）]]**：复位后缺省使用的堆栈指针，用于操作系统内核以及异常处理例程（包括中断服务例程）   
>   **[[进程堆栈指针（PSP）]]**：由用户的应用程序代码使用。堆栈指针的最低两位永远是 0，这意味着堆栈总是 4 字节对齐的。 
> 
> c、R14：**连接寄存器（LR）**当呼叫一个子程序时，由 R14 存储返回地址          
> 
> d、R15：**程序计数寄存器（PC）**指向当前的程序地址，如果修改它的值，就能改变程序的执行流（这里有很多高级技巧）          
> 
> e、Cortex-M3 还在内核水平上搭载了若干特殊功能寄存器，包括程序状态字寄存器组（PSRs）中断屏蔽寄存器组（PRIMASK, FAULTMASK, BASEPRI）   
> 控制寄存器（CONTROL）

在 Keil 菜单栏点击【view】->【Registers Window】打开寄存器窗口，查看 R14(LR) 的值。

![](https://tc8483.oss-cn-beijing.aliyuncs.com/img/0d9d133af4814c0b879b7d639e06934f.png)  
若 R14(LR) = 0xFFFFFFE9 或 0xFFFFFFF9, 查看 MSP（主堆栈指针）的值；  
若 R14(LR) = 0xFFFFFFED 或 0xFFFFFFFD, 查看  PSP（进程栈指针）的值。

![](https://tc8483.oss-cn-beijing.aliyuncs.com/img/647393450e3d3fc90f1adc084db2a859.png)  
------------------------------------- 图 2 -------------------------------------  
上图的 R14(LR) = 0xFFFF FFFD，则查看 PSP（进程栈指针)的值。

② 找到相应堆栈的指针，在内存中查看相应堆栈里的内容。

由于异常发生时，内核将 R0~R3、R12、R14(LR)、PC、XPRS 寄存器依次入栈，其中 R14(LR) 即为发生异常前 PC 将要执行的下一条指令地址。  
注意：寄存器均是 32 位、**且 STM32 是小端模式 (高位在后面，逆序读)**。（参考 Cortex_M3 权威指南）

![](https://tc8483.oss-cn-beijing.aliyuncs.com/img/37d253e172e25312a17f3f42415d2ff9.png)


------------------------------------- 图 3 -------------------------------------

从 图 2 可看到 SP 的值为 0x20000B2C，在 Keil 菜单栏点击【view】->【Memory Windows】->【Memory1】，在【Address】地址栏中输入 SP 的值 0x20000B2C，然后查看堆栈里面的值依次是 R0~R3、R12、R14(LR)、PC、XPRS。

![](https://tc8483.oss-cn-beijing.aliyuncs.com/img/4308c52b2111becddfb78a8d7d6f11dd.png)  
------------------------------------- 图 4 -------------------------------------  
显然堆栈后第 21 个字节到 24 字节即为 LR，图 4 显示该地址为 0x08005907 即为异常前 PC 将要执行的下一条指令地址。

③ 找到将要执行下一条指令的位置

在 Keil 菜单栏中点击【view】->【Disassembly Window】, 在【Disassembly Window】窗口中右击，在下拉菜单中选择【Show Disassembly at Address...】。在弹出框【Show Code at Address】的地址框中输入地址 0x08005907 进行搜索，然后就会找到相对应的代码。

![](https://tc8483.oss-cn-beijing.aliyuncs.com/img/d2dcdac7f367ddb331f017651575f945.png)  
------------------------------------- 图 5 -------------------------------------